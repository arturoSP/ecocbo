---
title: "ecocbo-guide"
author: "Edlin Guerra-Castro and Arturo Sanchez-Porras"
output: rmarkdown::html_vignette

vignette: >
  %\VignetteIndexEntry{Cost-benefit optimization for ecological sampling, from simulated communty data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
library(SSP)
library(ecocbo)

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.retina=2,
  fig.align='center',
  fig.width = 7, 
  fig.height = 5,
  warning = FALSE,
  message = FALSE
)
```
------------

## ecocbo: A package to optimize the experiment design through simulated data

**ecocbo** is ah R package designed to help in the task of defining an optimal sampling effort for community ecology studies based on either the definition of a desired level of precission, or the requirement of adjusting to a set economic budget, as proposed by Underwood (1997).
This package uses as basis the procedures to simulate ecological communities, considering the natural variability of the studied system, as was proposed by the package **SSP**, to further cut costs as it only requires to do a pilot study in order to determine the optimal number of sites and samples necessary to reach a given statistical power.
**ecocbo** is composed by four main functions: `sim_beta` for computing the statistical power at different sampling efforts, `plot_power` allows the user to visualize the changes in statistical power given the certain number of sampling units or sites, `scompvar` calculates the components of variation among sites and within samples, and `sim_cbo` estimates the optimal number of replicated units and replicates per unit depending on the major constrains of budget or precision to be achieved.

------------

## Functions and sequence
### 0. Preparing the data

As it was stated earlier, **ecocbo** uses simulated ecological communities as produced by `SSP:simdata` to take advantage of the considerations of natural variability that it produces. As such, it is necessary to prepare the data using the tools provided by **SSP**.
To demonstrate the functionality of **ecocbo**, a basic example that is based on the documentation of **SSP** is provided.
The provided data `epiDat` is a subset of the original `epibionts` (Guerra-Castro, et al., 2021) that was prepared by looking for communities that were as different as possible within the dataset. The data is prepared by saving it on two different objects: `epiH0` in which the data is treated as if it came from the same site thus accepting the null hypothesis, and `epiHa` in which the opposite is true, so that the samples come from different sites and portray different characteristics. The defining variable for doing so is `site` which will be set toa single label for `epiH0`, and left as-is for `epiHa`.
**SSP** workflow then requires simulation parameters to be computed, this is done with `SSP::assempar` for both datasets. This data is then used for the simulation of ecological communities, which is done by `SSP::simdata`, and that results in the data that will be used to work with **ecocbo**.
It is important to consider that I order for the resulting datasets to be the same size, the parameters `sites` and `N` for `SSP::simdata(parH0, ...)` will be 1 and the result of multiplying `sites` and `N` in `SSP::simdata(parHa, ...)`, respectively. For this example the values used to calculate `simH0` are `sites=1` and `N=1000`, and then `sites=10` and `N=100` for `simHa`, which results in (`cases`=)3 matrixes of (`sites`*`N`=)1000 rows and 95 columns (this depends on the simulation parameters from `assempar`).

```{r}
# Load data and adjust it.
data(epiDat)

epiH0 <- epiDat
epiH0[,"site"] <- as.factor("T0")
epiHa <- epiDat
epiHa[,"site"] <- as.factor(epiHa[,"site"])

# Calculate simulation parameters.
parH0 <- SSP::assempar(data = epiH0, type = "counts", Sest.method = "average")
parHa <- SSP::assempar(data = epiHa, type = "counts", Sest.method = "average")

# Simulation.
simH0 <- SSP::simdata(parH0, cases = 3, N = 1000, sites = 1)
simHa <- SSP::simdata(parHa, cases = 3, N = 100, sites = 10)

```

### 1. sim_beta
**sim_beta** computes the statistical power for a combination of up to `m` sites and `n` samples per site. Its arguments are: 

| Argument | Description |
|:---------|:------------|
| simH0 | Simulated community from `SSP::simdata` in which H0 is true. |
| simHa| Simulated community from `SSP::simdata` in which H0 is false. |
| n | Maximum number of samples to consider. |
| m | Maximum number of sites. |
| k | Number of resamples the process will take. Defaults to 50. |
| alpha | Level of significance for Type I error. Defaults to 0.05. |

The value of `k` defines the number of times that the combination of sites and samples will be considered to form a statistical distribution that will establish, along with `alpha`, the probability of type I error from the simulated data.

The function returns an object of class "ecocbo_beta" which prints to a table showing the statistical power at different sampling efforts, and is a list that contains two data frames, one containing the information about power and beta, and a second one that contains the results of the resampling of values indicated by `k`.

```{r}
betaResult <- sim_beta(simH0, simHa, n = 10, m = 3, k = 20, alpha = 0.05)
betaResult

```

### 2. plot_power
**plot_power** makes plots for either a power curve, a density plot, or both. Its parameters are:

| Argument | Description |
|:---------|:------------|
| data | Object of class "ecocbo_beta" that results from **sim_beta**. |
| n | Defaults to NULL, and then the function computes the number of samples (n) that results in a sampling effort close to 95% in power. If provided, said number of samples will be used. |
| m | Site label to be used as basis for the plot. |
| method | The desired plot. Options are "power", "density" or "both". |

The power curve plot shows that the power of the study increases as the sample size increases, and the density plot shows the overlapping areas where alpha and beta are significant.
The argument `n` is set to NULL by default, if it is left like that, the the function looks for a number of samples that allows for a power that is close to 95%, otherwise it uses the value stated by the user. In either case, the computed or provided value is marked in red in the plot.
The density plot shows a helping vertical line that marks the value of pseudoF that is critical according to the alpha that was set in **sim_beta**.

```{r}
plot_power(data = betaResult, n = NULL, m = 2, method = "both")

```

### 3. scompvar
**scompvar** calculates the components of variation within sites and among replicates. Its arguments are:

| Argument | Description |
|:---------|:------------|
| data | Object of class "ecocbo_beta" that results from **sim_beta**. |
| n | Site label to be used as basis for the computation. Defaults to NULL. |
| m | Number of samples to be considered. Defaults to NULL. |

If `m` or `n` are left as NULL, the function will calculate the components of variation using the largest available values as set in the experimental design in **sim_beta**.

```{r}
compVar <- scompvar(data = betaResult)
compVar

```

### 4. sim_cbo
**sim_cbo** estimates the optimal number of sites and replicates per site to perform based on either available budget or desired precision.


| Argument | Description |
|:---------|:------------|
| comp.var | Data frame as obtained from **scompvar**. |
| multSE | Optional. Required multivariate standard error for the sampling experiment. |
| ct | Optional. Total cost for the sampling experiment. |
| ck | Cost per replicate. |
| cj | Cost per unit. |

It is necessary to indicate one of the two optional arguments, as that parameter dictates if the function will work either based on budget or precision.

```{r}
cboResult <- sim_cbo(comp.var = compVar, ct = 20000, ck = 100, cj = 2500)

```




















